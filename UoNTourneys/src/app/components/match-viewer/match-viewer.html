<div class="page-container">
  <!-- SEARCH -->
  <mat-card class="search-card mat-elevation-z4">
    <div class="search-header">
      <div>
        <h1>Match Stats</h1>
        <p class="subtitle">
          Enter a FACEIT match ID to pull stats and compare teams.
        </p>
      </div>

      <mat-chip-set>
        <mat-chip color="primary" selected>
          <mat-icon>sports_esports</mat-icon>
          CS2 路 FACEIT
        </mat-chip>
      </mat-chip-set>
    </div>

    <mat-card-content>
      <form (ngSubmit)="onFetch()" class="search-form">
        <mat-form-field appearance="outline" class="match-id-field">
          <mat-label>Match ID</mat-label>
          <input
            matInput
            [(ngModel)]="matchId"
            name="matchId"
            placeholder="e.g. 1-961f1182-24de-43a8-81f9-5a43efbeab3c" />
        </mat-form-field>

        <button mat-raised-button color="accent" type="submit" class="search-button">
          <mat-icon>search</mat-icon>
          <span>Fetch match</span>
        </button>
      </form>

      <div class="loading" *ngIf="loading">
        <mat-progress-spinner mode="indeterminate" diameter="48"></mat-progress-spinner>
      </div>

      <mat-card *ngIf="error" class="error-card">
        <mat-icon color="warn">error_outline</mat-icon>
        <span>{{ error }}</span>
      </mat-card>
    </mat-card-content>
  </mat-card>

  <!-- SUMMARY -->
  <mat-card *ngIf="match && !loading" class="summary-card mat-elevation-z3">
    <mat-card-content>
      <div class="summary-left">
        <h2>{{ match.map }}</h2>
        <div class="summary-label">Map</div>
      </div>

      <mat-divider vertical></mat-divider>

      <div class="summary-middle">
        <div class="summary-row">
          <span class="label">Region</span>
          <span class="value">{{ match.region }}</span>
        </div>
        <div class="summary-row">
          <span class="label">Rounds</span>
          <span class="value">{{ match.rounds }}</span>
        </div>
        <div class="summary-row score-row">
          <span class="label">Score</span>
          <span class="value summary-score">{{ match.score }}</span>
        </div>
      </div>

      <mat-divider vertical></mat-divider>

      <div class="summary-right">
        <div class="summary-row id-row" matTooltip="{{ match.matchId }}">
          <span class="label">Match ID</span>
          <span class="value id">{{ match.matchId }}</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- TEAMS & PLAYERS -->
  <div *ngIf="match && !loading" class="teams-wrapper">
    <mat-card
      *ngFor="let team of match.teams"
      [ngClass]="getTeamCssClass(team)"
      class="team-card mat-elevation-z3">

      <mat-card-header>
        <div mat-card-avatar class="team-avatar">
          <mat-icon>groups</mat-icon>
        </div>

        <mat-card-title class="team-title">
          <span class="team-name">{{ team.name }}</span>
        </mat-card-title>

        <mat-card-subtitle>
          <span>Total kills: {{ getTotalKills(team) }}</span>
          <span *ngIf="getAverageADR(team) as avgAdr">
            路 Avg ADR: {{ avgAdr | number : '1.0-1' }}
          </span>
        </mat-card-subtitle>

        <div class="header-badges">
          <mat-chip *ngIf="team.win" color="primary" selected>
            <mat-icon>emoji_events</mat-icon>
            Winner
          </mat-chip>
        </div>
      </mat-card-header>

      <mat-card-content>
        <!-- BIG CENTER SCORE -->
        <div class="team-score-row">
          <div class="team-score-pill" [class.winning]="team.win">
            {{ team.finalScore }}
          </div>
        </div>

        <div class="top-fragger" *ngIf="getTopFragger(team) as top">
          <mat-icon>whatshot</mat-icon>
          <span class="label">Top fragger:</span>
          <span class="name">{{ top.nickname }}</span>
          <span class="stats">
            {{ top.kills }} K / {{ top.deaths }} D
            <span *ngIf="top.kdRatio !== undefined">
              路 K/D {{ top.kdRatio | number : '1.2-2' }}
            </span>
            <span *ngIf="top.adr !== undefined">
              路 ADR {{ top.adr | number : '1.0-1' }}
            </span>
          </span>
        </div>

        <table mat-table [dataSource]="team.players" class="mat-elevation-z1 player-table">

          <ng-container matColumnDef="nickname">
            <th mat-header-cell *matHeaderCellDef> Player </th>
            <td mat-cell *matCellDef="let p">
              {{ p.nickname }}
            </td>
          </ng-container>

          <ng-container matColumnDef="kills">
            <th mat-header-cell *matHeaderCellDef> K </th>
            <td mat-cell *matCellDef="let p"> {{ p.kills }} </td>
          </ng-container>

          <ng-container matColumnDef="deaths">
            <th mat-header-cell *matHeaderCellDef> D </th>
            <td mat-cell *matCellDef="let p"> {{ p.deaths }} </td>
          </ng-container>

          <ng-container matColumnDef="kd">
            <th mat-header-cell *matHeaderCellDef> K/D </th>
            <td mat-cell *matCellDef="let p">
              {{ p.kdRatio !== undefined ? (p.kdRatio | number : '1.2-2') : '-' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="adr">
            <th mat-header-cell *matHeaderCellDef> ADR </th>
            <td mat-cell *matCellDef="let p">
              {{ p.adr !== undefined ? (p.adr | number : '1.0-1') : '-' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="hs">
            <th mat-header-cell *matHeaderCellDef> HS% </th>
            <td mat-cell *matCellDef="let p">
              {{ p.headshotPercent !== undefined ? (p.headshotPercent | number : '1.0-0') + '%' : '-' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="mvps">
            <th mat-header-cell *matHeaderCellDef> MVPs </th>
            <td mat-cell *matCellDef="let p">
              <span *ngIf="p.mvps !== undefined">{{ p.mvps }}</span>
              <span *ngIf="p.mvps === undefined">-</span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns; trackBy: trackByPlayer"
          ></tr>
        </table>
      </mat-card-content>
    </mat-card>
  </div>
</div>
